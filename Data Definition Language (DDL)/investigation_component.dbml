/////////////////////////////////////////////////////
// HAZARD TYPE
/////////////////////////////////////////////////////

Table hazard_type {
  hazard_type_id integer [pk, increment]
  hazard_type varchar(100) [not null]
  health_risk_rating_id integer [not null, ref: > health_risk_rating.health_Risk_rating_id] // matches column name in health_risk_rating
  category varchar(500)
}

/////////////////////////////////////////////////////
// HAZARD REPORT
/////////////////////////////////////////////////////

Table hazard_report {
  hazard_report_id integer [pk, increment]
  hazard_report_reference varchar(36) [not null, ref: > reference.id]
  uprn varchar(50) [not null, ref: > address.uprn]
  tenancy_id varchar(50) [not null, ref: > tenancy.tenancy_id]
  hazard_type_id integer [not null, ref: > hazard_type.hazard_type_id]
  date_reported date [not null]
  reported_by_id integer [not null, ref: > person.person_id]
  description varchar(500)
  location_details varchar(500)
  emergency_action_taken integer [not null, default: `0`, note: 'CHECK (emergency_action_taken IN (0,1))']
  made_safe_date date
  report_status_id integer [not null, ref: > report_status.report_status_id]
}

/////////////////////////////////////////////////////
// INVESTIGATION
/////////////////////////////////////////////////////

Table investigation {
  investigation_id integer [pk, increment]
  investigation_reference varchar(36) [not null, ref: > reference.id]
  uprn varchar(50) [not null, ref: > address.uprn]
  tenancy_id varchar(50) [not null, ref: > tenancy.tenancy_id]
  hazard_report_id integer [not null, ref: > hazard_report.hazard_report_id]
  trigger_source_id integer [not null, ref: > trigger_source.trigger_source_id]
  investigation_type_id integer [not null, ref: > investigation_type.investigation_type_id]
  investigation_scheduled_date date
  investigation_completed_date date
  investigator_id integer [not null, ref: > investigator.investigator_id]
  hazard_confirmed integer [not null, default: `0`, note: 'CHECK (hazard_confirmed IN (0,1))']
  repair_required integer [not null, default: `0`, note: 'CHECK (repair_required IN (0,1))']
  sla_breach_flag integer [not null, default: `0`, note: 'CHECK (sla_breach_flag IN (0,1))']
  notification_sent_to_tenant integer [not null, default: `0`, note: 'CHECK (notification_sent_to_tenant IN (0,1))']
  investigation_notes varchar(500)
}

/////////////////////////////////////////////////////
// INVESTIGATION_HAZARD
/////////////////////////////////////////////////////

Table investigation_hazard {
  investigation_hazard_id integer [pk, increment]
  hazard_type_id integer [not null, ref: > hazard_type.hazard_type_id]
  investigation_id integer [not null, ref: > investigation.investigation_id]
  hazard_report_id integer [not null, ref: > hazard_report.hazard_report_id]
  severity_id integer [not null, ref: > severity.severity_id]
  notes varchar(500)
}

/////////////////////////////////////////////////////
// NOTIFICATION
/////////////////////////////////////////////////////

Table notification {
  notification_id integer [pk, increment]
  investigation_id integer [ref: > investigation.investigation_id]
  tenancy_id integer [not null, ref: > tenancy.tenancy_id]
  work_order_id integer [ref: > work_order.work_order_id]
  notification_type_id integer [not null, ref: > notification_type.notification_type_id]
  escalation_id integer [ref: > escalation.escalation_id]
  date_sent date [not null]
  communication_method_id integer [not null, ref: > communication_method.communication_method_id]
  content_summary varchar(500)
}

/////////////////////////////////////////////////////
// COMMUNICATION
/////////////////////////////////////////////////////

Table communication {
  communication_id integer [pk, increment]
  notification_id integer [ref: > notification.notification_id]
  hazard_report_id integer [ref: > hazard_report.hazard_report_id]
  investigation_id integer [ref: > investigation.investigation_id]
  tenancy_id varchar(50) not null // ref: > tenancy.tenancy_id
  sender_type varchar(20) [not null, note: 'CHECK (sender_type IN (''Tenant'',''Landlord'',''System''))']
  sender_id integer // ref: > person.person_id
  receiver_type varchar(20) [not null, note: 'CHECK (receiver_type IN (''Tenant'',''Landlord'',''System''))']
  receiver_id integer //ref: > person.person_id
  communication_method_id integer [not null, ref: > communication_method.communication.method_id]
  communication_date datetime [not null, default: `CURRENT_TIMESTAMP`]
  content_summary varchar(500)
  media_id integer [ref: > media.media_id]
}

/////////////////////////////////////////////////////
// ESCALATION
/////////////////////////////////////////////////////

Table escalation {
  escalation_id integer [pk, increment]
  escalation_reference varchar(36) [not null, ref: > reference.id]
  investigation_id integer [not null, ref: > investigation.investigation_id]
  escalation_reason varchar(100)
  escalation_stage_id integer [not null, ref: > escalation_stage.escalation_stage_id]
  escalation_type_id integer [not null, ref: > escalation_type.escalation_type_id]
  escalated_to varchar(100) [not null]
  escalation_start_date date [not null]
  escalation_end_date date
  action_taken varchar(500)
  compensation_amount decimal(10,2)
  alternative_accommodation_details varchar(500)
  tenant_acceptance integer [not null, default: `0`, note: 'CHECK (tenant_acceptance IN (0,1))']
  escalation_notes varchar(500)

  Note: 'CHECK (escalation_end_date IS NULL OR escalation_end_date >= escalation_start_date); CHECK (compensation_amount IS NULL OR compensation_amount >= 0).'
}

/////////////////////////////////////////////////////
// REFERENCE
/////////////////////////////////////////////////////

Table reference {
  id integer [pk, increment]
  allocated_by_code integer [not null]
  allocated_by_description varchar(50) [not null]
  description varchar(200)
  allocated_by varchar(50) [not null]
}

/////////////////////////////////////////////////////
// CODE LISTS
/////////////////////////////////////////////////////

Table health_risk_rating {
  health_Risk_rating_id integer [pk, increment] // capital R per DDL
  health_risk_rating varchar(20) [not null]
}

Table severity {
  severity_id integer [pk, increment]
  severity varchar(20) [not null]
}

Table investigation_type {
  investigation_type_id integer [pk, increment]
  investigation_type varchar(20) [not null]
}

Table report_status {
  report_status_id integer [pk, increment]
  report_status varchar(20) [not null]
}

Table trigger_source {
  trigger_source_id integer [pk, increment]
  trigger_source varchar(20) [not null]
}

Table escalation_status {
  escalation_status_id integer [pk, increment]
  escalation_status varchar(20) [not null]
}

Table notification_type {
  notification_type_id integer [pk, increment]
  notification_type varchar(20) [not null]
}

Table escalation_stage {
  escalation_stage_id integer [pk, increment]
  escalation_stage varchar(20) [not null]
}

Table communication_method {
  communication_method_id integer [pk, increment]   // spelled exactly as in DDL
  communication_method varchar(20) [not null]       // spelled exactly as in DDL

}

Table escalation_type {
  escalation_type_id integer [pk, increment]
  escalation_type varchar(30) [not null]
}

Table investigator {
  investigator_id integer [pk, increment]
  investigator_name varchar(100) [not null]
}

/////////////////////////////////////////////////////
// MEDIA
/////////////////////////////////////////////////////

Table media {
  media_id integer [pk, increment]
  hazard_report_id integer [not null, ref: > hazard_report.hazard_report_id]
  media_type varchar(10) [not null, note: 'CHECK (media_type IN (''photo'',''video''))']
  media_attachment attachment [not null]
  uploaded_by_id integer [not null, ref: > person.person_id]
  date_uploaded datetime [not null, default: `CURRENT_TIMESTAMP`]
}

/////////////////////////////////////////////////////
// INVESTIGATION HISTORY
/////////////////////////////////////////////////////

Table investigation_history {
  history_id integer [pk, increment]
  investigation_id integer [not null, ref: > investigation.investigation_id]

  // Snapshot of related entities at the time
  hazard_id integer [not null, ref: > hazard.hazard_id]
  tenant_id integer [not null, ref: > tenant.tenant_id]
  property_id integer [not null, ref: > property.property_id]

  // Previous vs new types
  previous_hazard_type_id integer [ref: > hazard_type.hazard_type_id]
  new_hazard_type_id integer [ref: > hazard_type.hazard_type_id]

  previous_investigation_type_id integer [ref: > investigation_type.investigation_type_id]
  new_investigation_type_id integer [ref: > investigation_type.investigation_type_id]

  previous_escalation_status_id integer
  new_escalation_status_id integer

  reason text [not null]
  action_taken text [not null]

  // Audit metadata
  recorded_by integer [not null, ref: > person.person_id]
  recorded_at timestamp [not null, default: `CURRENT_TIMESTAMP`]

  // Optional links per DDL constraints
  work_order_id integer [ref: > work_order.work_order_id]
  appointment_id integer [ref: > appointment.appointment_id]
}
