// DBML script for investigation Module schema
// Author(s): George Foster (TPXImpact), Rizwan Nobeebux (Data Futurists), Elena Iurco (Data Futurists)
// Email(s): george.foster@tpximpact.com, rizwan.nobeebux@datafuturists.com, elena.iurco@datafuturists.com

// Script created for use with dbdiagram.io for ERD

// --------------------------------------
// investigation Component
// --------------------------------------

// Main Tables

table hazard_type {
  hazard_type_id integer [pk, increment]
  hazard_type nvarchar(100)
  health_risk_rating_id integer
  category nvarchar(500)

  Note: "Stores types of hazards"
  Indexes {
    (health_risk_rating_id)
  }
}


table hazard_report {
  hazard_report_id integer [pk, increment]
  property_id integer
  tenant_id varchar(50)
  date_reported date
  reported_by nvarchar(100)
  description nvarchar(500)
  photo_evidence nvarchar(500)
  location_details nvarchar(500)
  emergency_action_taken integer [default: 0]
  made_safe_date date
  further_work_required integer [default: 0]
  further_work_due_date date
  report_status_id integer
  investigation_type_id integer

  Note: "Stores hazard reports"
}

table investigation {
  investigation_id integer [pk, increment]
  property_id integer
  tenant_id varchar(50)
  tenancy_id varchar(50)
  hazard_report_id integer
  trigger_source_id integer
  investigation_type_id integer
  investigation_scheduled_date date
  investigation_completed_date date
  inspector_name nvarchar(100)
  hazard_confirmed integer [default: 0]
  repair_required integer [default: 0]
  repair_scheduled_date date
  repair_completed_date date
  sla_breach_flag integer [default: 0]
  escalation_status_id integer
  notification_sent_to_tenant integer [default: 0]
  investigation_notes nvarchar(500)

  Note: "Stores investigation details"
}

table investigation_hazard {
  investigation_hazard_id integer [pk, increment]
  hazard_type_id integer
  investigation_id integer
  hazard_report_id integer
  severity_id integer
  notes nvarchar(500)

  Note: "Maps investigations to hazards"
}

table notification {
  notification_id integer [pk, increment]
  investigation_id integer
  tenant_id varchar(50)
  work_order_id varchar(255)
  notification_type_id integer
  date_sent date
  notification_method_id integer
  content_summary nvarchar(500)

  Note: "Notifications related to investigations"
}

table escalation {
  escalation_id integer [pk, increment]
  investigation_id integer
  escalation_reason nvarchar(100)
  escalation_stage_id integer
  escalation_type_id integer
  escalated_to nvarchar(100)
  escalation_start_date date
  escalation_end_date date
  action_taken nvarchar(500)
  compensation_offered integer [default: 0]
  compensation_amount decimal(10,2)
  alternative_accommodation_offered integer [default: 0]
  alternative_accommodation_details nvarchar(500)
  tenant_acceptance integer [default: 0]
  escalation_notes nvarchar(500)

  Note: "Tracks escalation actions"
}

// Code Lists

table health_risk_rating {
  health_risk_rating_id integer [pk, increment]
  health_risk_rating nvarchar(20)
}

table severity {
  severity_id integer [pk, increment]
  severity nvarchar(20)
}

table investigation_type {
  investigation_type_id integer [pk, increment]
  investigation_type nvarchar(20)
}

table report_status {
  report_status_id integer [pk, increment]
  report_status nvarchar(20)
}

table trigger_source {
  trigger_source_id integer [pk, increment]
  trigger_source nvarchar(20)
}

table escalation_status {
  escalation_status_id integer [pk, increment]
  escalation_status nvarchar(20)
}

table notification_type {
  notification_type_id integer [pk, increment]
  notification_type nvarchar(20)
}

table escalation_stage {
  escalation_stage_id integer [pk, increment]
  escalation_stage nvarchar(20)
}

table notification_method {
  notification_method_id integer [pk, increment]
  notification_method nvarchar(20)
}

table escalation_type {
  escalation_type_id integer [pk, increment]
  escalation_type nvarchar(30)
}

table inspector {
  inspector_id integer [pk, increment]
  inspector_name nvarchar(100)
}

// Relationships
ref: hazard_type.health_risk_rating_id > health_risk_rating.health_risk_rating_id
//ref: hazard_report.property_id > property.property_id
//ref: hazard_report.tenant_id > tenant_person.tenant_id
ref: hazard_report.report_status_id > report_status.report_status_id
ref: hazard_report.investigation_type_id > investigation_type.investigation_type_id
//ref: investigation.property_id > property.property_id
//ref: investigation.tenant_id > tenant_person.tenant_id
//ref: investigation.tenancy_id > tenancy.tenancy_id
ref: investigation.hazard_report_id > hazard_report.hazard_report_id
ref: investigation.trigger_source_id > trigger_source.trigger_source_id
ref: investigation.investigation_type_id > investigation_type.investigation_type_id
ref: investigation.escalation_status_id > escalation_status.escalation_status_id
ref: investigation_hazard.hazard_type_id > hazard_type.hazard_type_id
ref: investigation_hazard.investigation_id > investigation.investigation_id
ref: investigation_hazard.hazard_report_id > hazard_report.hazard_report_id
ref: investigation_hazard.severity_id > severity.severity_id
ref: notification.investigation_id > investigation.investigation_id
//ref: notification.tenant_id > tenant_person.tenant_id
//ref: notification.work_order_id > work_order.work_order_id
ref: notification.notification_type_id > notification_type.notification_type_id
ref: notification.notification_method_id > notification_method.notification_method_id
ref: escalation.investigation_id > investigation.investigation_id
ref: escalation.escalation_stage_id > escalation_stage.escalation_stage_id
ref: escalation.escalation_type_id > escalation_type.escalation_type_id

// --------------------------------------
// Property Component
// --------------------------------------

// Main Tables

Table site {
  site_id integer [pk]
  site_name varchar(255) [not null]
}

Table property {
  property_id integer [pk]
  property_name varchar(255) [not null]
  site_id integer [not null]
}

Table unit {
  unit_id integer [pk]
  property_id integer [not null]
  alert_type_id integer 
  lease varchar(255)
}

Table address {
  address_id integer [pk]
  unit_id integer [not null]
  address_line varchar(255)
  building_name varchar(255)
  street_name varchar(255)
  building_number varchar(50)
  floor integer
  city_name varchar(100) [not null]
  country varchar(100) [not null]
  post_code varchar(20) [not null]
}

Table physical_characteristics {
  physical_char_id integer [pk]
  property_id integer [not null]
  window_glazing_type_id integer
  wall_insulation_type_id integer
  roof_insulation_type_id integer
  ventilation_type varchar(100)
  built_year integer
  construction_type_id integer 
  last_updated_date date [not null]
}

Table heating_system {
  heating_system_id integer [pk]
  property_id integer [not null]
  energy_control varchar(100)
  heat_conversion_method varchar(100)
  purpose varchar(100)
  is_smart_system boolean [default: false]
  installation_date date
  manufacturer varchar(255)
  model_number varchar(100)
  last_serviced_date date
  notes text
}

Table thermal_transmittance {
  thermal_trans_id integer [pk]
  physical_char_id integer [not null]
  u_value numeric(5,3) [not null]
  element varchar(100) [not null]
  measurement_date date [not null]
  notes text
}

Table energy_performance_certification {
  epc_id integer [pk]
  unit_id integer [not null]
  certificate_number varchar(50) [unique, not null]
  current_energy_rating integer [not null]
  current_energy_band char [not null]
  potential_energy_rating integer [not null]
  potential_energy_band char [not null]
  current_env_impact_rating integer [not null]
  current_env_impact_band char [not null]
  potential_env_impact_rating integer [not null]
  potential_env_impact_band char [not null]
  co2_per_year integer [not null]
  space_heating_cost_year numeric(10,2) [not null]
  water_heating_cost_year numeric(10,2) [not null]
  lighting_cost_year numeric(10,2) [not null]
  total_energy_cost_year numeric(12,2) [not null]
  energy_use_per_sqm_year integer [not null]
  recommendation_summary text
}

Table certification {
  certification_id integer [pk]
  unit_id integer [not null]
  certification_type_id integer [not null]
  issue_date date [not null]
  expiry_date date [not null]
  issued_by varchar(255) [not null]
  status varchar(50) [not null]
  attachment_url varchar(2048)
}

// Codelists/lookup Tables

Table energy_efficiency_band_code {
  band_id integer [pk]
  code char [unique, not null]
}

Table location_alert_type_code {
  alert_type_id integer [pk]
  code varchar(50) [unique, not null]
}

Table glazing_layer_type_code {
  glazing_type_id integer [pk]
  code varchar(50) [unique, not null]
}

Table roof_insulation_type_code {
  insulation_type_id integer [pk]
  code varchar(50) [unique, not null]
}

Table wall_insulation_type_code {
  insulation_type_id integer [pk]
  code varchar(50) [unique, not null]
}

Table construction_type_code {
  construction_type_id integer [pk]
  code varchar(50) [unique, not null]
}

Table certification_type_code {
  certification_type_id integer [pk]
  code varchar(50) [unique, not null]
}

// Relationships

Ref: property.site_id > site.site_id
Ref: unit.property_id > property.property_id
Ref: unit.alert_type_id > location_alert_type_code.alert_type_id
Ref: address.unit_id > unit.unit_id
Ref: physical_characteristics.property_id > property.property_id
Ref: physical_characteristics.window_glazing_type_id > glazing_layer_type_code.glazing_type_id
Ref: physical_characteristics.wall_insulation_type_id > wall_insulation_type_code.insulation_type_id
Ref: physical_characteristics.roof_insulation_type_id > roof_insulation_type_code.insulation_type_id
Ref: physical_characteristics.construction_type_id > construction_type_code.construction_type_id
Ref: heating_system.property_id > property.property_id
Ref: thermal_transmittance.physical_char_id > physical_characteristics.physical_char_id
Ref: energy_performance_certification.unit_id > unit.unit_id
Ref: energy_performance_certification.current_energy_band > energy_efficiency_band_code.band_id
Ref: energy_performance_certification.potential_energy_band > energy_efficiency_band_code.band_id
Ref: energy_performance_certification.current_env_impact_band > energy_efficiency_band_code.band_id
Ref: energy_performance_certification.potential_env_impact_band > energy_efficiency_band_code.band_id
Ref: certification.unit_id > unit.unit_id
Ref: certification.certification_type_id > certification_type_code.certification_type_id

// --------------------------------------
// Tenant Component
// --------------------------------------

// Main Tables

Table Tenant {
    TenantID varchar(50) [pk]
    FullName varchar(255) [not null]
    DateOfBirth date
    ContactDetails text
    VulnerabilityFlag boolean [default: false]
    PersonAlertCode varchar(50)
}

Table Tenancy {
    TenancyID varchar(50) [pk]
    TenantID varchar(50) [not null]
    AddressID varchar(50) [not null]
    StartDate date [not null]
    EndDate date
    TenancyType varchar(100)
    TenancyStatus varchar(100)
}

Table HouseholdMemberPerson {
    HouseholdMemberID varchar(50) [pk]
    TenantID varchar(50) [not null]
    TenancyID varchar(50) [not null]
    FullName varchar(255) [not null]
    DateOfBirth date
    RelationshipToTenant varchar(100)
    IsContractHolder boolean [default: false]
    VulnerabilityDetails text
    PersonAlertCode varchar(50)
    RiskAssessmentStatus varchar(100)
    RiskAssessmentDate date
}

// Relationships

Ref: Tenancy.TenantID > Tenant.TenantID
Ref: HouseholdMemberPerson.TenantID > Tenant.TenantID
Ref: HouseholdMemberPerson.TenancyID > Tenancy.TenancyID

// --------------------------------------
// WorkOrder Component
// --------------------------------------

// Main Tables

Table ContractorOrganisation {
  ContractorOrganisationID varchar PK
  Name varchar
  ContractorPortal varchar
  Subcontractors text
}

Table WorkClass {
  WorkClassID varchar PK
  WorkClassCodeID varchar
  WorkClassCode varchar
  WorkClassDescription text
}

Table WorkPriority {
  WorkPriorityID varchar PK
  WorkPriorityCodeID varchar
  WorkPriorityCode varchar
  WorkPriorityDescription text
  EffectiveDateTime timestamp
  NumberOfDays int
  Comments text
  RequiredStartDate date
  RequiredCompletionDate date
}



Table RateScheduleItem {
  RateScheduleItemID varchar PK
  RateScheduleItemCodeID varchar
  M3NHFSORCode varchar
  Quantity decimal
  CustomCode varchar
  CustomName varchar
}

Table WorkOrder {
  WorkOrderID varchar PK
  WorkElementID varchar
  AddressID varchar
  investigationID varchar
  EscalationID varchar
  TenancyID varchar
  TenantID varchar
  HazardReportID varchar
  WorkClassID varchar
  LocationAlertID varchar
  PersonAlertID varchar
  WorkPriorityID varchar
  ContractorOrganisationID varchar
  DateRaised date
  DateReported date
  PlannedStartDate date
  PlannedFinishDate date
  ActualStartDateTime timestamp
  ActualCompletionDateTime timestamp
  DescriptionOfWork text
  EstimatedCost decimal
  EstimatedLabourHours decimal
  LocationOfRepair varchar
  JobStatusUpdate varchar
  RepairSLABreachFlag varchar
}

Table WorkElement {
  WorkElementID varchar PK
  WorkOrderID varchar
  RateScheduleItemID varchar
  TradeCodeID varchar
  ServiceChargeSubject varchar
}

Table WorkElementDependency {
  WorkElementID varchar PK
  DependsOnWorkElementID varchar
  Type varchar
  Timing varchar
  Description text
}

Table WorkOrderStatusHistory {
  WorkOrderStatusHistoryID varchar PK
  WorkOrderID varchar
  StatusCode varchar
  UpdatedBy varchar
  Reason text
  ReasonCode varchar
  CreatedDateTime timestamp
  EnteredDateTime timestamp
  ExistedDateTime timestamp
  Comments text
}

Table WorkOrderComplete {
  WorkOrderCompleteID varchar PK
  WorkOrderID varchar
  BillOfMeterialItem varchar
  CompletedWorkElements text
  OperativesUsed text
  JobStatusUpdate varchar
  FollowOnWork varchar
}

Table WorkOrderAccessInformation {
  WorkOrderAccessInformationID varchar PK
  WorkOrderID varchar
  Description varchar
  KeySafe text
}

Table AlertRegardingLocation {
  LocationAlertID varchar PK
  LocationAlertCodeID varchar
  AlertType varchar
  Attachments text
  Comments text
}

Table AlertRegardingPerson {
  PersonAlertID varchar PK
  PersonAlertCodeID varchar
  AlertType varchar
  Comments text
}

// Codes Tables

Table TradeCodes {
  TradeCodeID varchar PK
  TradeCode varchar
  CustomCode varchar
  CustomName varchar
  Description text
}

Table WorkPriorityCodes {
  WorkPriorityCodeID varchar PK
  WorkPriorityCode varchar
  Description text
}

Table WorkClassCodes {
  WorkClassCodeID varchar PK
  WorkClassCode varchar
  Description text
}

Table RateScheduleItemCodes {
  RateScheduleItemCodeID varchar PK
  RateScheduleItemCode varchar
  Description text
}

Table PersonAlertTypeCodes {
  PersonAlertCodeID varchar PK
  PersonAlertCode varchar
  Description text
}

Table LocationAlertTypeCodes {
  LocationAlertCodeID varchar PK
  LocationAlertCode varchar
  Description text
}



Ref: WorkOrder.WorkClassID > WorkClass.WorkClassID
Ref: WorkOrder.WorkPriorityID > WorkPriority.WorkPriorityID
Ref: WorkOrder.ContractorOrganisationID > ContractorOrganisation.ContractorOrganisationID
Ref: WorkOrder.LocationAlertID > AlertRegardingLocation.LocationAlertID
Ref: WorkOrder.PersonAlertID > AlertRegardingPerson.PersonAlertID
Ref: WorkOrder.AddressID > address.address_id
Ref: WorkOrder.investigationID > investigation.investigation_id
Ref: WorkOrder.EscalationID > escalation.escalation_id
Ref: WorkOrder.TenancyID > Tenancy.TenancyID
Ref: WorkOrder.TenantID > Tenant.TenantID
Ref: WorkOrder.HazardReportID > hazard_report.hazard_report_id

Ref: WorkElement.WorkOrderID > WorkOrder.WorkOrderID
Ref: WorkElement.RateScheduleItemID > RateScheduleItem.RateScheduleItemID
Ref: WorkElement.TradeCodeID > TradeCodes.TradeCodeID
Ref: WorkElementDependency.WorkElementID > WorkElement.WorkElementID
Ref: WorkElementDependency.DependsOnWorkElementID > WorkElement.WorkElementID

Ref: WorkOrderStatusHistory.WorkOrderID > WorkOrder.WorkOrderID

Ref: WorkOrderComplete.WorkOrderID > WorkOrder.WorkOrderID

Ref: WorkOrderAccessInformation.WorkOrderID > WorkOrder.WorkOrderID

Ref: AlertRegardingLocation.LocationAlertCodeID > LocationAlertTypeCodes.LocationAlertCodeID
Ref: AlertRegardingPerson.PersonAlertCodeID > PersonAlertTypeCodes.PersonAlertCodeID
Ref: WorkPriority.WorkPriorityCodeID > WorkPriorityCodes.WorkPriorityCodeID
Ref: WorkClass.WorkClassCodeID > WorkClassCodes.WorkClassCodeID
Ref: RateScheduleItem.RateScheduleItemCodeID > RateScheduleItemCodes.RateScheduleItemCodeID





