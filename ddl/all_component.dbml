// DBML script for investigation Module schema
// Author(s): George Foster (TPXImpact), Rizwan Nobeebux (Data Futurists), Elena Iurco (Data Futurists)
// Email(s): george.foster@tpximpact.com, rizwan.nobeebux@datafuturists.com, elena.iurco@datafuturists.com

// Script created for use with dbdiagram.io for ERD

// --------------------------------------
// investigation Component
// --------------------------------------

// Main Tables

Table HazardType {
  HazardTypeID int [pk, increment]
  HazardType nvarchar(100)
  HealthRiskRatingID int
  Category nvarchar(500)

  Note: 'Stores types of hazards and their associated health risk ratings.'
}

Table investigationHazard {
  investigationHazardID int [pk, increment]
  HazardTypeID int
  investigationID int
  HazardReportID int
  SeverityID int
  Notes nvarchar(500)

  Note: 'Links investigations with reported hazards including severity and notes.'
}

Table HazardReport {
  HazardReportID int [pk, increment]
  PropertyID int
  TenantID int
  DateReported date
  ReportedBy nvarchar(100)
  Description nvarchar(500)
  PhotoEvidence nvarchar(500)
  LocationDetails nvarchar(500)
  InvestigationTypeID int
  InvestigationDueDate date
  EmergencyActionTaken bit
  MadeSafeDate date
  FurtherWorkRequired bit
  FurtherWorkDueDate date
  ReportStatusID int

  Note: 'Captures reported hazards including details and status.'
}

Table investigation {
  investigationID int [pk, increment]
  PropertyID int
  TenantID int
  TenancyID int
  HazardReportID int
  TriggerSourceID int 
  HazardReportedDate date
  investigationScheduledDate date
  investigationCompletedDate date
  InspectorName nvarchar(100)
  HazardConfirmed bit
  RepairRequired bit
  RepairScheduledDate date
  RepairCompletedDate date
  SLABreachFlag bit
  EscalationStatusID int
  NotificationSentToTenant bit
  investigationNotes nvarchar(500)

  Note: 'Details investigations including schedule, status, and outcomes.'
}

Table Notification {
  NotificationID int [pk, increment]
  investigationID int
  TenantID int
  WorkOrderID int
  NotificationTypeID int
  DateSent date
  NotificationMethodID int
  ContentSummary nvarchar(500)

  Note: 'Records notifications sent to tenants about investigations or repairs.'
}

Table Escalation {
  EscalationID int [pk, increment]
  investigationID int
  EscalationReason nvarchar(100)
  EscalationStageID int
  EscalationTypeID int
  EscalatedTo nvarchar(100)
  EscalationStartDate date
  EscalationEndDate date
  ActionTaken nvarchar(500)
  CompensationOffered bit
  CompensationAmount decimal(10,2)
  AlternativeAccommodationOffered bit
  AlternativeAccommodationDetails nvarchar(500)
  TenantAcceptance bit
  EscalationNotes nvarchar(500)

  Note: 'Tracks escalations made during the investigation or repair process.'
}

// Codelists/lookup Tables

Table HealthRiskRating {
  HealthRiskRatingID int [pk, increment]
  HealthRiskRating nvarchar(20)

  Note: 'Defines levels of health risk (e.g., High, Medium, Low).'
}

Table Severity {
  SeverityID int [pk, increment]
  Severity nvarchar(20)

  Note: 'Defines severity levels used in hazard reporting.'
}

Table InvestigationType {
  InvestigationTypeID int [pk, increment]
  InvestigationType nvarchar(20)

  Note: 'Defines types of investigations conducted.'
}

Table ReportStatus {
  ReportStatusID int [pk, increment]
  ReportStatus nvarchar(20)

  Note: 'Defines statuses for hazard reports.'
}

Table TriggerSource {
  TriggerSourceID int [pk, increment]
  TriggerSource nvarchar(20)

  Note: 'Defines what triggered an investigation.'
}

Table EscalationStatus {
  EscalationStatusID int [pk, increment]
  EscalationStatus nvarchar(20)

  Note: 'Defines the status of an escalation.'
}

Table NotificationType {
  NotificationTypeID int [pk, increment]
  NotificationType nvarchar(20)

  Note: 'Defines types of notifications sent.'
}

Table NotificationMethod {
  NotificationMethodID int [pk, increment]
  NotificationMethod nvarchar(20)

  Note: 'Defines methods of delivering notifications.'
}

Table EscalationStage {
  EscalationStageID int [pk, increment]
  EscalationStage nvarchar(20)

  Note: 'Defines stages of the escalation process.'
}

Table EscalationType {
  EscalationTypeID int [pk, increment]
  EscalationType nvarchar(30)

  Note: 'Defines types of escalation actions taken.'
}

// Relationships

Ref: HazardType.HealthRiskRatingID > HealthRiskRating.HealthRiskRatingID
Ref: investigationHazard.HazardTypeID > HazardType.HazardTypeID
Ref: investigationHazard.investigationID > investigation.investigationID
Ref: investigationHazard.HazardReportID > HazardReport.HazardReportID
Ref: investigationHazard.SeverityID > Severity.SeverityID
Ref: HazardReport.PropertyID > property.property_id
Ref: HazardReport.TenantID > Tenant.TenantID
Ref: HazardReport.InvestigationTypeID > InvestigationType.InvestigationTypeID
Ref: HazardReport.ReportStatusID > ReportStatus.ReportStatusID
Ref: investigation.PropertyID > property.property_id
Ref: investigation.TenantID > Tenant.TenantID
Ref: investigation.TenancyID > Tenancy.TenancyID
Ref: investigation.HazardReportID > HazardReport.HazardReportID
Ref: investigation.TriggerSourceID > TriggerSource.TriggerSourceID
Ref: investigation.EscalationStatusID > EscalationStatus.EscalationStatusID
Ref: Notification.investigationID > investigation.investigationID
Ref: Notification.TenantID > Tenant.TenantID
Ref: Notification.WorkOrderID > WorkOrder.WorkOrderID
Ref: Notification.NotificationTypeID > NotificationType.NotificationTypeID
Ref: Notification.NotificationMethodID > NotificationMethod.NotificationMethodID
Ref: Escalation.investigationID > investigation.investigationID
Ref: Escalation.EscalationStageID > EscalationStage.EscalationStageID
Ref: Escalation.EscalationTypeID> EscalationType.EscalationTypeID

// --------------------------------------
// Property Component
// --------------------------------------

// Main Tables

Table site {
  site_id integer [pk]
  site_name varchar(255) [not null]
}

Table property {
  property_id integer [pk]
  property_name varchar(255) [not null]
  site_id integer [not null]
}

Table unit {
  unit_id integer [pk]
  property_id integer [not null]
  alert_type_id integer 
  lease varchar(255)
}

Table address {
  address_id integer [pk]
  unit_id integer [not null]
  address_line varchar(255)
  building_name varchar(255)
  street_name varchar(255)
  building_number varchar(50)
  floor integer
  city_name varchar(100) [not null]
  country varchar(100) [not null]
  post_code varchar(20) [not null]
}

Table physical_characteristics {
  physical_char_id integer [pk]
  property_id integer [not null]
  window_glazing_type_id integer
  wall_insulation_type_id integer
  roof_insulation_type_id integer
  ventilation_type varchar(100)
  built_year integer
  construction_type_id integer 
  last_updated_date date [not null]
}

Table heating_system {
  heating_system_id integer [pk]
  property_id integer [not null]
  energy_control varchar(100)
  heat_conversion_method varchar(100)
  purpose varchar(100)
  is_smart_system boolean [default: false]
  installation_date date
  manufacturer varchar(255)
  model_number varchar(100)
  last_serviced_date date
  notes text
}

Table thermal_transmittance {
  thermal_trans_id integer [pk]
  physical_char_id integer [not null]
  u_value numeric(5,3) [not null]
  element varchar(100) [not null]
  measurement_date date [not null]
  notes text
}

Table energy_performance_certification {
  epc_id integer [pk]
  unit_id integer [not null]
  certificate_number varchar(50) [unique, not null]
  current_energy_rating integer [not null]
  current_energy_band char [not null]
  potential_energy_rating integer [not null]
  potential_energy_band char [not null]
  current_env_impact_rating integer [not null]
  current_env_impact_band char [not null]
  potential_env_impact_rating integer [not null]
  potential_env_impact_band char [not null]
  co2_per_year integer [not null]
  space_heating_cost_year numeric(10,2) [not null]
  water_heating_cost_year numeric(10,2) [not null]
  lighting_cost_year numeric(10,2) [not null]
  total_energy_cost_year numeric(12,2) [not null]
  energy_use_per_sqm_year integer [not null]
  recommendation_summary text
}

Table certification {
  certification_id integer [pk]
  unit_id integer [not null]
  certification_type_id integer [not null]
  issue_date date [not null]
  expiry_date date [not null]
  issued_by varchar(255) [not null]
  status varchar(50) [not null]
  attachment_url varchar(2048)
}

// Codelists/lookup Tables

Table energy_efficiency_band_code {
  band_id integer [pk]
  code char [unique, not null]
}

Table location_alert_type_code {
  alert_type_id integer [pk]
  code varchar(50) [unique, not null]
}

Table glazing_layer_type_code {
  glazing_type_id integer [pk]
  code varchar(50) [unique, not null]
}

Table roof_insulation_type_code {
  insulation_type_id integer [pk]
  code varchar(50) [unique, not null]
}

Table wall_insulation_type_code {
  insulation_type_id integer [pk]
  code varchar(50) [unique, not null]
}

Table construction_type_code {
  construction_type_id integer [pk]
  code varchar(50) [unique, not null]
}

Table certification_type_code {
  certification_type_id integer [pk]
  code varchar(50) [unique, not null]
}

// Relationships

Ref: property.site_id > site.site_id
Ref: unit.property_id > property.property_id
Ref: unit.alert_type_id > location_alert_type_code.alert_type_id
Ref: address.unit_id > unit.unit_id
Ref: physical_characteristics.property_id > property.property_id
Ref: physical_characteristics.window_glazing_type_id > glazing_layer_type_code.glazing_type_id
Ref: physical_characteristics.wall_insulation_type_id > wall_insulation_type_code.insulation_type_id
Ref: physical_characteristics.roof_insulation_type_id > roof_insulation_type_code.insulation_type_id
Ref: physical_characteristics.construction_type_id > construction_type_code.construction_type_id
Ref: heating_system.property_id > property.property_id
Ref: thermal_transmittance.physical_char_id > physical_characteristics.physical_char_id
Ref: energy_performance_certification.unit_id > unit.unit_id
Ref: energy_performance_certification.current_energy_band > energy_efficiency_band_code.band_id
Ref: energy_performance_certification.potential_energy_band > energy_efficiency_band_code.band_id
Ref: energy_performance_certification.current_env_impact_band > energy_efficiency_band_code.band_id
Ref: energy_performance_certification.potential_env_impact_band > energy_efficiency_band_code.band_id
Ref: certification.unit_id > unit.unit_id
Ref: certification.certification_type_id > certification_type_code.certification_type_id

// --------------------------------------
// Tenant Component
// --------------------------------------

// Main Tables

Table Tenant {
    TenantID varchar(50) [pk]
    FullName varchar(255) [not null]
    DateOfBirth date
    ContactDetails text
    VulnerabilityFlag boolean [default: false]
    PersonAlertCode varchar(50)
}

Table Tenancy {
    TenancyID varchar(50) [pk]
    TenantID varchar(50) [not null]
    AddressID varchar(50) [not null]
    StartDate date [not null]
    EndDate date
    TenancyType varchar(100)
    TenancyStatus varchar(100)
}

Table HouseholdMemberPerson {
    HouseholdMemberID varchar(50) [pk]
    TenantID varchar(50) [not null]
    TenancyID varchar(50) [not null]
    FullName varchar(255) [not null]
    DateOfBirth date
    RelationshipToTenant varchar(100)
    IsContractHolder boolean [default: false]
    VulnerabilityDetails text
    PersonAlertCode varchar(50)
    RiskAssessmentStatus varchar(100)
    RiskAssessmentDate date
}

// Relationships

Ref: Tenancy.TenantID > Tenant.TenantID
Ref: HouseholdMemberPerson.TenantID > Tenant.TenantID
Ref: HouseholdMemberPerson.TenancyID > Tenancy.TenancyID

// --------------------------------------
// WorkOrder Component
// --------------------------------------

// Main Tables

Table ContractorOrganisation {
  ContractorOrganisationID varchar PK
  Name varchar
  ContractorPortal varchar
  Subcontractors text
}

Table WorkClass {
  WorkClassID varchar PK
  WorkClassCodeID varchar
  WorkClassCode varchar
  WorkClassDescription text
}

Table WorkPriority {
  WorkPriorityID varchar PK
  WorkPriorityCodeID varchar
  WorkPriorityCode varchar
  WorkPriorityDescription text
  EffectiveDateTime timestamp
  NumberOfDays int
  Comments text
  RequiredStartDate date
  RequiredCompletionDate date
}



Table RateScheduleItem {
  RateScheduleItemID varchar PK
  RateScheduleItemCodeID varchar
  M3NHFSORCode varchar
  Quantity decimal
  CustomCode varchar
  CustomName varchar
}

Table WorkOrder {
  WorkOrderID varchar PK
  WorkElementID varchar
  AddressID varchar
  investigationID varchar
  EscalationID varchar
  TenancyID varchar
  TenantID varchar
  HazardReportID varchar
  WorkClassID varchar
  LocationAlertID varchar
  PersonAlertID varchar
  WorkPriorityID varchar
  ContractorOrganisationID varchar
  DateRaised date
  DateReported date
  PlannedStartDate date
  PlannedFinishDate date
  ActualStartDateTime timestamp
  ActualCompletionDateTime timestamp
  DescriptionOfWork text
  EstimatedCost decimal
  EstimatedLabourHours decimal
  LocationOfRepair varchar
  JobStatusUpdate varchar
  RepairSLABreachFlag varchar
}

Table WorkElement {
  WorkElementID varchar PK
  WorkOrderID varchar
  RateScheduleItemID varchar
  TradeCodeID varchar
  ServiceChargeSubject varchar
}

Table WorkElementDependency {
  WorkElementID varchar PK
  DependsOnWorkElementID varchar
  Type varchar
  Timing varchar
  Description text
}

Table WorkOrderStatusHistory {
  WorkOrderStatusHistoryID varchar PK
  WorkOrderID varchar
  StatusCode varchar
  UpdatedBy varchar
  Reason text
  ReasonCode varchar
  CreatedDateTime timestamp
  EnteredDateTime timestamp
  ExistedDateTime timestamp
  Comments text
}

Table WorkOrderComplete {
  WorkOrderCompleteID varchar PK
  WorkOrderID varchar
  BillOfMeterialItem varchar
  CompletedWorkElements text
  OperativesUsed text
  JobStatusUpdate varchar
  FollowOnWork varchar
}

Table WorkOrderAccessInformation {
  WorkOrderAccessInformationID varchar PK
  WorkOrderID varchar
  Description varchar
  KeySafe text
}

Table AlertRegardingLocation {
  LocationAlertID varchar PK
  LocationAlertCodeID varchar
  AlertType varchar
  Attachments text
  Comments text
}

Table AlertRegardingPerson {
  PersonAlertID varchar PK
  PersonAlertCodeID varchar
  AlertType varchar
  Comments text
}

// Codes Tables

Table TradeCodes {
  TradeCodeID varchar PK
  TradeCode varchar
  CustomCode varchar
  CustomName varchar
  Description text
}

Table WorkPriorityCodes {
  WorkPriorityCodeID varchar PK
  WorkPriorityCode varchar
  Description text
}

Table WorkClassCodes {
  WorkClassCodeID varchar PK
  WorkClassCode varchar
  Description text
}

Table RateScheduleItemCodes {
  RateScheduleItemCodeID varchar PK
  RateScheduleItemCode varchar
  Description text
}

Table PersonAlertTypeCodes {
  PersonAlertCodeID varchar PK
  PersonAlertCode varchar
  Description text
}

Table LocationAlertTypeCodes {
  LocationAlertCodeID varchar PK
  LocationAlertCode varchar
  Description text
}



Ref: WorkOrder.WorkClassID > WorkClass.WorkClassID
Ref: WorkOrder.WorkPriorityID > WorkPriority.WorkPriorityID
Ref: WorkOrder.ContractorOrganisationID > ContractorOrganisation.ContractorOrganisationID
Ref: WorkOrder.LocationAlertID > AlertRegardingLocation.LocationAlertID
Ref: WorkOrder.PersonAlertID > AlertRegardingPerson.PersonAlertID
Ref: WorkOrder.AddressID > address.address_id
Ref: WorkOrder.investigationID > investigation.investigationID
Ref: WorkOrder.EscalationID > Escalation.EscalationID
Ref: WorkOrder.TenancyID > Tenancy.TenancyID
Ref: WorkOrder.TenantID > Tenant.TenantID
Ref: WorkOrder.HazardReportID > HazardReport.HazardReportID

Ref: WorkElement.WorkOrderID > WorkOrder.WorkOrderID
Ref: WorkElement.RateScheduleItemID > RateScheduleItem.RateScheduleItemID
Ref: WorkElement.TradeCodeID > TradeCodes.TradeCodeID
Ref: WorkElementDependency.WorkElementID > WorkElement.WorkElementID
Ref: WorkElementDependency.DependsOnWorkElementID > WorkElement.WorkElementID

Ref: WorkOrderStatusHistory.WorkOrderID > WorkOrder.WorkOrderID

Ref: WorkOrderComplete.WorkOrderID > WorkOrder.WorkOrderID

Ref: WorkOrderAccessInformation.WorkOrderID > WorkOrder.WorkOrderID

Ref: AlertRegardingLocation.LocationAlertCodeID > LocationAlertTypeCodes.LocationAlertCodeID
Ref: AlertRegardingPerson.PersonAlertCodeID > PersonAlertTypeCodes.PersonAlertCodeID
Ref: WorkPriority.WorkPriorityCodeID > WorkPriorityCodes.WorkPriorityCodeID
Ref: WorkClass.WorkClassCodeID > WorkClassCodes.WorkClassCodeID
Ref: RateScheduleItem.RateScheduleItemCodeID > RateScheduleItemCodes.RateScheduleItemCodeID





